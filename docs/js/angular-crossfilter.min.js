/**
 * @module ngCrossfilter
 * @author Adam Timberlake
 * @link https://github.com/Wildhoney/ngCrossfilter
 *
 * @param $angular Angular.js      https://angularjs.org/                      (Required)
 * @param $crossfilter             https://github.com/square/crossfilter       (Required)
 * @param $moment                  http://momentjs.com/
 * @param _                        http://underscorejs.org/
 */
!function(t,e,i,s){"use strict"
var n=function(t){throw"ngCrossfilter: "+t+"."}
void 0===t&&n("ngCrossfilter Requires Angular.js"),void 0===e&&n("ngCrossfilter Requires Crossfilter")
var o=void 0!==s,r=function(t){return"function"==typeof Array.isArray?Array.isArray(t):void 0!==s?s.isArray(t):"[object Array]"==typeof t},a={HAS_UNDERSCORE:o,fuzzy:function(t){return function(e,i){var s=new RegExp(e,t)
return!!i.match(s)}},dateTimeRange:function(t,e){return void 0===i&&n("You need to install Moment.js to use dateTimeRange"),function(s,o){var r=s[0]===-1/0?0:i(s[0],t).unix(),a=s[1]===1/0?1/0:i(s[1],t).unix(),p=i(o,t).unix()
return(r<0||a<0||p<0)&&n("Date/Time parsing appears to be using invalid format"),"function"==typeof e?e(p,r,a):p>=r&&p<=a}},regexp:function(){return function(t,e){return t instanceof RegExp||n("Expression must be an instance of RegExp"),!!e.match(t)}},bitwise:function(t){return function(e,i){var s=e&i
return"!"===t?!s:s}},inArray:function(t){return this._inArray(t,!1)},notInArray:function(t){return this._inArray(t,!0)},_inArray:function(t,e){var i=o
return function(o,a){r(a)||(a=[a]),r(o)||(o=[o]),t=t||"every",t&&-1===["every","some"].indexOf(t)&&n("You must pass either 'every' or 'some'"),i||"function"==typeof[].every&&"function"==typeof[].some||n("Browser does not support `every` and/or `some` methods")
var p=function(t){var i=-1!==a.indexOf(t)
return e?!i:i}
return i?s[t](o,p):o[t](p)}}}
t.module("ngCrossfilter",[]).service("Crossfilter",["$rootScope",function(i){var p=function(t,e,i,s){t=t||[],this._resetAll(),this._initialise(t,e,i,s)}
return p.filters=a,p.prototype=[],p.prototype.STRATEGY_PERSISTENT="persistent",p.prototype.STRATEGY_TRANSIENT="transient",p.prototype.PRIMARY_DIMENSION="__primaryKey",p.prototype.PRIMARY_SPECIAL="$id",p.prototype.HAS_UNDERSCORE=o,p.prototype._crossfilter={},p.prototype._cacheGroups={},p.prototype._specialId=1,p.prototype._dimensions={},p.prototype._primaryKey="",p.prototype._sortProperty="",p.prototype._isAscending=!0,p.prototype._lastFilter="",p.prototype._strategy="",p.prototype._deletedKeys=[],p.prototype._identifier="",p.prototype._isBroadcastEventEnabled=!0,p.prototype.filters=a,p.prototype._isArray=r,p.prototype._initialise=function(i,s,o,a){if(r(i)||n("Collection must be an array"),o=o||this.STRATEGY_PERSISTENT,-1===[this.STRATEGY_PERSISTENT,this.STRATEGY_TRANSIENT].indexOf(o)&&n("Strategy must be either '"+this.STRATEGY_PERSISTENT+"' or '"+this.STRATEGY_TRANSIENT+"'"),s&&a&&-1===a.indexOf(s)&&n("Primary key '"+s+"' as one of the dimensions"),i[0]){var p=!(s in i[0])
i.length&&s&&p&&s!==this.PRIMARY_SPECIAL&&n("Primary key '"+s+"' is not in the collection")}s===this.PRIMARY_SPECIAL&&t.forEach(i,function(t){t[this.PRIMARY_SPECIAL]=++this._specialId}.bind(this)),a=a||this._getProperties(i[0]),this._crossfilter=e(i),this._strategy=o,this._primaryKey=s||a[0]||"",this._defineDimensions(a),this._primaryKey&&this.primaryKey(this._primaryKey),this.broadcastEvent()},p.prototype._defineDimensions=function(e){t.forEach(e,function(t){this.addDimension(t,null,!0)}.bind(this))},p.prototype.primaryKey=function(t){this._primaryKey=t,this.addDimension(this.PRIMARY_DIMENSION,function(e){return e[t]}.bind(this),!0)},p.prototype.filterBy=function(t,e,i){if(this._cacheGroups={},this._assertDimensionExists(t),void 0!==i&&"function"!=typeof i)throw n("Custom filter method must be a function")
if(this._lastFilter&&this._strategy===this.STRATEGY_TRANSIENT&&this.unfilterBy(this._lastFilter),this._lastFilter=t,"function"==typeof i)return this._dimensions[t].filterFunction(function(t){return i(e,t)}),void this.broadcastEvent()
this._dimensions[t].filter(e),this.broadcastEvent()},p.prototype.unfilterBy=function(t){this._cacheGroups={},this._assertDimensionExists(t),this._dimensions[t].filterAll(),this.broadcastEvent()},p.prototype.unfilterAll=function(){this._cacheGroups={}
for(var t in this._dimensions)this._dimensions.hasOwnProperty(t)&&this._dimensions[t].filterAll()
this._finaliseDeleteRestore(),this.broadcastEvent()},p.prototype.sortBy=function(t,e){if(this._assertDimensionExists(t),"boolean"==typeof e)return this._isAscending=e,void(this._sortProperty=t);(this._sortProperty||this._primaryKey)===t&&(this._isAscending=!this._isAscending),this._sortProperty=t,this.broadcastEvent()},p.prototype.unsortAll=function(t){this._sortProperty=this._primaryKey,!0!==t&&(this._isAscending=!0),this.broadcastEvent()},p.prototype.addDimension=function(t,e,i){e=e||function(e){return e[t]},i||this._assertValidDimensionName(t),this._dimensions[t]=this._crossfilter.dimension(e)},p.prototype.deleteDimension=function(t){this._assertDimensionExists(t),this._dimensions[t].dispose(),delete this._dimensions[t]},p.prototype.first=function(){return this.collection()[0]},p.prototype.last=function(){return this.collection()[this.collection().length-1]},p.prototype.countBy=function(t,e){if(this._cacheGroups[t])return this._cacheGroups[t][e]||0
this._assertDimensionExists(t)
var i={},s=this._dimensions[t].group().all()
for(var n in s)if(s.hasOwnProperty(n)){var o=s[n]
i[o.key]=o.value}return this._cacheGroups[t]=i,i[e]||0},p.prototype.groupBy=function(t,e){if(this._assertDimensionExists(t),void 0===e)return this._dimensions[t].group(function(t){return t}).all()
"object"!=typeof e&&n("Custom reducer must be an object")
var i=e.add||function(t){return t+1},s=e.remove||function(t){return t-1},o=e.initial||function(){return 0}
return"function"==typeof i&&"function"==typeof s&&"function"==typeof o||n("Custom reducer's `add`, `remove`, and `initial` properties must be functions"),this._dimensions[t].group(function(t){return t}).reduce(i,s,o).all()},p.prototype.models=function(t,e){return this.collection("number"==typeof e?e:1/0).splice("number"==typeof t?t:1/0)},p.prototype.addModel=function(t){return this.addModels([t])},p.prototype.addModels=function(e){if(this._cacheGroups={},!this._primaryKey){var i=this.HAS_UNDERSCORE?s.keys:Object.keys
this.primaryKey(i(e[0])[0])
var n=!0
for(var o in this._dimensions)this._dimensions.hasOwnProperty(o)&&(n=!1)
n||this._defineDimensions(this._getProperties(e[0]))}return this._primaryKey===this.PRIMARY_SPECIAL&&t.forEach(e,function(t){t[this.PRIMARY_SPECIAL]=++this._specialId}.bind(this)),this._crossfilter.add(e),this.broadcastEvent(),e.length},p.prototype.updateModel=function(t,e){t.hasOwnProperty(this.PRIMARY_SPECIAL)||n("`updateModel` only works when PK is defined as `"+this.PRIMARY_SPECIAL+"`"),this.deleteModel(t)
for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])
t[this.PRIMARY_SPECIAL]=++this._specialId,this.addModel(t),this.broadcastEvent()},p.prototype.deleteModel=function(t){return this.deleteModels([t])},p.prototype.deleteModels=function(t){this._cacheGroups={}
for(var e=this._getKeys(t),i=0;i<e.length;i++)i!==this.PRIMARY_DIMENSION&&this._deletedKeys.push(e[i])
return this._finaliseDeleteRestore(),this.broadcastEvent(),e.length},p.prototype.restoreModel=function(t){return this.restoreModels([t])},p.prototype.restoreModels=function(t){for(var e=this._getKeys(t),i=0;i<e.length;i++){var s=this._deletedKeys.indexOf(e[i])
this._deletedKeys.splice(s,1)}return this._finaliseDeleteRestore(),this.broadcastEvent(),e.length},p.prototype.broadcastEvent=function(t){(this._isBroadcastEventEnabled||!0===t)&&i.$broadcast("crossfilter/updated",this.collection(),this._identifier)},p.prototype.enableBroadcastEvent=function(){this._isBroadcastEventEnabled=!0},p.prototype.disableBroadcastEvent=function(){this._isBroadcastEventEnabled=!1},p.prototype.crossfilter=function(){return this._crossfilter},p.prototype.collection=function(t){var e=this._sortProperty||this.PRIMARY_DIMENSION,i=this._isAscending?"bottom":"top"
return void 0===this._dimensions[e]?this:this._dimensions[e][i](t||1/0)},p.prototype.identifyAs=function(t){this._identifier=t},p.prototype._finaliseDeleteRestore=function(){var t=this._deletedKeys
this._dimensions[this.PRIMARY_DIMENSION].filter(function(e){return-1===t.indexOf(e)})},p.prototype._assertDimensionExists=function(t){void 0===this._dimensions[t]&&n("Unable to find dimension named '"+t+"'")},p.prototype._assertValidDimensionName=function(t){t===this.PRIMARY_DIMENSION&&n("Cannot define dimension using special dimension: '"+this.PRIMARY_DIMENSION+"'")
for(var e in this._dimensions)e===t&&n("Cannot overwrite an existing dimension: '"+e+"'")},p.prototype._getProperties=function(t){var e=[]
for(var i in t)t.hasOwnProperty(i)&&e.push(i)
return e},p.prototype._getKeys=function(e){var i=[]
return t.forEach(e,function(t){var e=t[this._primaryKey]
void 0===e&&n("Unable to find the primary key in model: '"+this._primaryKey+"'"),i.push(e)}.bind(this)),i},p.prototype._resetAll=function(){this._crossfilter={},this._cacheGroups={},this._deletedKeys=[],this._dimensions={}},p.prototype.toString=function(){return"[object Array]"},p}])}(window.angular,window.crossfilter,window.moment,window._)
